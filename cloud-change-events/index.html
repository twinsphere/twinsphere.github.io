<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://docs.aas.conplement.cloud/cloud-change-events/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Change Events - Documentation of twinsphere Suite by conplement AG</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Change Events";
        var mkdocs_page_input_path = "cloud-change-events.md";
        var mkdocs_page_url = "/cloud-change-events/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../img/twinsphere-logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../contact/">Contact us</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">twinsphere ID</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../id-overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../cloud-documentation/">API Documentation</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Proprietary Features</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../cloud-proprietary-features/">Overview</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Change Events</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#connecting-to-the-broker">Connecting to the broker</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#certificate-creation">Certificate creation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#connecting">Connecting</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#topics-message-contracts-and-qos">Topics, message contracts and QoS</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mqtt-protocol-details">MQTT protocol details</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#additional-information">Additional information</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cloud-search/">Search</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cloud-push-service/">Push Service</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cloud-semantic-connector/">Semantic Connector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cloud-filter-queries/">Shell Filter Queries</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cloud-file-filter-queries/">File Filter Queries</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cloud-auth/">Authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cloud-client-generation/">Client Generation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cloud-release-notes/">Release Notes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Studio</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../studio-overview/">Coming 2025</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Viewer</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../viewer-overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../viewer-features/">Features</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../viewer-release-notes/">Release Notes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Management API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../management-overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../management-roles/">Roles</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development Libraries</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../typed-aas-metamodels-overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../typed-aas-metamodels-submodels/">Supported Submodels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../typed-aas-metamodels-validation/">Validation Rules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../typed-aas-metamodels-release_notes/">Release Notes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Validators</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../validators-overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tips & Tricks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tips-common-validation-errors/">Common Validation Errors</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Documentation of twinsphere Suite by conplement AG</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Cloud</li>
          <li class="breadcrumb-item">Proprietary Features</li>
      <li class="breadcrumb-item active">Change Events</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="change-events">Change Events</h1>
<p>Besides the HTTP/REST based API endpoint, twinsphere also offers a MQTT based API for receiving events about shells and
submodels.</p>
<h2 id="connecting-to-the-broker">Connecting to the broker</h2>
<p>Connection is based on mutual-TLS authentication with certificates. At present, we only support the thumbprint matching
strategy.</p>
<h3 id="certificate-creation">Certificate creation</h3>
<ol>
<li>Create your own certificate (it can be self-signed or issued by a valid certificate authority, but ensure you store
   this certificate securely as a <strong>SECRET</strong>). You can simply follow this
   <a href="https://learn.microsoft.com/en-us/azure/event-grid/mqtt-publish-and-subscribe-cli#generate-a-sample-client-certificate-and-thumbprint">guide&nbsp;â§‰</a>
   or use a tool of your choice.</li>
<li>Send us the thumbprint via a <a href="../contact/">JIRA ticket request</a>. We will provide you with the connection details once
   the thumbprint has been granted access. The thumbprint itself is not a secret, so it can be sent through unsecured
   channels.</li>
</ol>
<blockquote>
<p>To test out the connection, we recommend using <a href="https://mqttx.app/">mqttx.app&nbsp;â§‰</a></p>
</blockquote>
<h3 id="connecting">Connecting</h3>
<p>Any MQTT 3.1 or 5.0 client library in any language is supported. Make sure you understand and distinguish between the
<strong>MQTT client ID</strong> (aka Session ID) and the <strong>username</strong> which you need to provide, like in <code>WithCredentials()</code> method
in the C# example below.</p>
<p>Your client ID (session ID) can have any value, but make sure it is fixed and not dynamic. This value will be used to
map the MQTT session back to your client in cases such as restarts and failures.</p>
<p>Here is a generic C# example with MQTTNet on how to establish a connection:</p>
<pre><code class="language-csharp">const string clientId = &quot;your-fixed-client-id-per-consumer&quot;; // aka Session ID
const string username = &quot;you will get this value from us&quot;;

var mqttClientConfiguration = new MqttClientOptionsBuilder()
    .WithClientId(clientId)
    .WithTcpServer(_eventBrokerHost, _eventBrokerPort)
    ...
    .WithCredentials(username, &quot;&quot;)
</code></pre>
<h4 id="single-connections">Single connections</h4>
<p>Most common case will be that you subscribe to events in a single-instance with a fixed clientId (any value as long as
it is fixed between deployments and restarts). In case of rolling deployments, you don't necessarily need to disconnect
the "old" client first. The old client will automatically get a disconnect once the new client connect with the same
username / clientId combination.</p>
<h4 id="multiple-connections">Multiple connections</h4>
<p>For cases where you want to have multiple concurrent connections, we support up to <strong>3 concurrent sessions per
"username".</strong></p>
<p>You can refer to <a href="https://learn.microsoft.com/en-us/azure/event-grid/mqtt-support#connection-flow-1">Microsoft docs&nbsp;â§‰</a> on
some session ID / client ID naming patterns in case of multiple concurrent connections.</p>
<h2 id="topics-message-contracts-and-qos">Topics, message contracts and QoS</h2>
<p>Following MQTT topics are supported:</p>
<ul>
<li><code>twinsphere/shells/&lt;shell id - base64 encoded!&gt;/created</code></li>
<li><code>twinsphere/shells/&lt;shell id - base64 encoded!&gt;/updated</code></li>
<li><code>twinsphere/shells/&lt;shell id - base64 encoded!&gt;/deleted</code></li>
<li><code>twinsphere/submodels/&lt;submodel id - base64 encoded!&gt;/created</code></li>
<li><code>twinsphere/submodels/&lt;submodel id - base64 encoded!&gt;/updated</code></li>
<li><code>twinsphere/submodels/&lt;submodel id - base64 encoded!&gt;/deleted</code></li>
</ul>
<p>MQTT wildcards for subscriptions are supported at the "id" level, for example, to subscribe to all shell update events,
use: <code>twinsphere/shells/+/updated</code></p>
<p>Messages are delivered with a <strong>QoS of 1 (at-least-once)</strong>, which means that duplicates are possible and should be
expected.</p>
<p>The MQTT message content (referred to here as the twinsphere envelope) follows the schema below:</p>
<pre><code class="language-yaml"># shell event envelope
version: string
timestamp: string (UTC in ISO 8601 format)
payload: JSON string (aas-core-works AssetAdministationShell meta model)

# submodel event envelope
version: string
timestamp: string (UTC in ISO 8601 format)
payload: JSON string (aas-core-works Submodel meta model)
affectedShellIds: JSON array of strings containing shells this submodel referenced at the time
</code></pre>
<p>The envelope is always <strong>compressed via gzip</strong>, so you should first decompress it. Then, to deserialize the JSON string
in the payload property, you can use the aas-core-works libraries for your target programming language or platform.</p>
<p>Below is a code snippet demonstrating how you could achieve this in C#:</p>
<pre><code class="language-csharp">
// If you are using MQTTnet, then your MQTT message (MqttApplicationMessage) should have a
// property called PayloadSegment. Using the extension method Decompress, defined below,
// you can do something like this:
var envelopeJson = msg.PayloadSegment.ToArray().Decompress();
var envelope = JsonSerializer.Deserialize&lt;ShellEvent&gt;(envelopeJson);

// now you can read envelope.Payload, which is a JSON structure that can be deserialized via
// core-works Jsonization helper from the https://github.com/aas-core-works/aas-core3.0-csharp

// you need a &quot;container&quot; to deserialize into - this is our envelope
public class ShellEvent
{
    [JsonPropertyName(&quot;version&quot;)]
    public required string Version { get; init; }

    [JsonPropertyName(&quot;timestamp&quot;)]
    public required string Timestamp { get; init; }

    [JsonPropertyName(&quot;payload&quot;)]
    public required string Payload { get; init; }
}

public static string Decompress(this byte[] compressedContent)
{
    using var compressedStream = new MemoryStream(compressedContent);
    using var gzipStream = new GZipStream(compressedStream, CompressionMode.Decompress);
    using var decompressedStream = new MemoryStream();
    gzipStream.CopyTo(decompressedStream);

    var decompressedBytes = decompressedStream.ToArray();
    return Encoding.UTF8.GetString(decompressedBytes);
}

</code></pre>
<p>To properly handle possible duplicate events on your side, make sure to use the timestamp property and ignore messages
newer than the timestamp you already processed.</p>
<h2 id="mqtt-protocol-details">MQTT protocol details</h2>
<p>For information on supported MQTT versions and limitations on MQTT features, please refer to <a href="https://learn.microsoft.com/en-us/azure/event-grid/mqtt-support">this
resource</a>. Equally important are the <a href="https://learn.microsoft.com/en-us/azure/event-grid/quotas-limits#mqtt-limits-in-event-grid-namespace">quotas &amp;
limitations</a>.</p>
<p>Especially important is to mention the limitations of the persistent sessions which is up to 100 messages / 8h per
topic.</p>
<h2 id="additional-information">Additional information</h2>
<p>There are several important aspects to note regarding the twinsphere interface:</p>
<ul>
<li>Events published are not issued immediately after a change is made via the REST API, there can be a delay of up to
  several minutes.</li>
<li>Duplicate events should be expected, and are commonplace when using QoS 1.</li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>If you encounter any issues, we recommend enabling tracing of MQTT messages depending on the library you are using. For
example, on the .NET Platform using MQTTNet, you can enable traces <a href="https://github.com/dotnet/MQTTnet/wiki/Trace">like
this</a>.</p>
<p>In some cases however, when it comes to features like authorization and topic permissions, you might experience
disconnects from the broker without detailed explanation. Ensure that you subscribe to the correct topic names and
double check for typos or similar issues. In the worst case scenario, don't hesitate to submit a ticket issue with us
for further assistance in debugging the problem.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../cloud-proprietary-features/" class="btn btn-neutral float-left" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cloud-search/" class="btn btn-neutral float-right" title="Search">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright &copy; 2025 <a href="https://www.conplement.de/twinsphere" taget="_blank">conplement AG</a></p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../cloud-proprietary-features/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cloud-search/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
      <script src="../js/open_in_new_tab.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
